<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniChain | Secure Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; background: #000; color: #fff; }
        .bg-uni-blue { background-color: #0033AD; }
        .text-uni-blue { color: #0033AD; }
        .glass-card { background: #0a0a0a; border: 1px solid #1a1a1a; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, textarea { background: #000 !important; color: #fff !important; border: 1px solid #333 !important; }
        input:focus { border-color: #0033AD !important; outline: none; }
        .breadcrumb-dot.active { background-color: #0033AD; box-shadow: 0 0 10px #0033AD; }
        
        #custom-modal { display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        #custom-modal.active { display: flex; }
    </style>
</head>
<body>

    <div id="custom-modal">
        <div class="glass-card p-8 rounded-[2rem] max-w-sm w-full mx-6 border-uni-blue text-center">
            <div id="modal-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-uni-blue/10"></div>
            <h3 id="modal-title" class="text-xl font-bold uppercase mb-2"></h3>
            <p id="modal-msg" class="text-gray-400 text-sm mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-uni-blue py-3 rounded-xl font-bold uppercase text-[10px]">Close</button>
        </div>
    </div>

    <nav class="fixed top-0 w-full z-50 bg-black/80 backdrop-blur-md border-b border-white/5 h-20 flex items-center px-6 justify-between">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="w-10 h-10 bg-uni-blue rounded flex items-center justify-center font-bold text-white">U</div>
            <span class="font-bold text-xl tracking-tighter">UniChain.rw</span>
        </div>
        <div id="auth-status" class="text-[10px] font-bold text-uni-blue bg-uni-blue/10 px-4 py-2 rounded-full border border-uni-blue/20 uppercase">
            System: <span id="status-text">Ready</span>
        </div>
    </nav>

    <main class="pt-32 pb-20 px-6 max-w-5xl mx-auto">

        <div id="view-portal-selection" class="view-section active">
            <h1 class="text-4xl font-bold mb-2 uppercase tracking-tighter">Identity <span class="text-uni-blue">Verification</span></h1>
            <p class="text-gray-500 mb-12 italic">Cardano-linked secure agreements for Rwanda.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="startWizard('student')" class="glass-card p-8 rounded-3xl text-left hover:border-uni-blue transition-all">
                    <i data-lucide="graduation-cap" class="text-uni-blue w-8 h-8 mb-4"></i>
                    <h3 class="font-bold">Student Verification</h3>
                    <p class="text-gray-500 text-sm">Verify academic credentials on-chain.</p>
                </button>
                <button onclick="startWizard('sacco')" class="glass-card p-8 rounded-3xl text-left hover:border-uni-blue transition-all">
                    <i data-lucide="landmark" class="text-uni-blue w-8 h-8 mb-4"></i>
                    <h3 class="font-bold">SACCO Banking</h3>
                    <p class="text-gray-500 text-sm">Financial integrity for local members.</p>
                </button>
                <button onclick="startWizard('p2p')" class="glass-card p-8 rounded-3xl text-left hover:border-uni-blue transition-all md:col-span-2">
                    <i data-lucide="users" class="text-uni-blue w-8 h-8 mb-4"></i>
                    <h3 class="font-bold">P2P Agreement</h3>
                    <p class="text-gray-500 text-sm">Secure peer-to-peer lending & trust.</p>
                </button>
            </div>
        </div>

        <div id="view-wizard" class="view-section">
            <div class="glass-card p-10 rounded-[2.5rem]">
                <div class="flex justify-between mb-12 max-w-xs mx-auto">
                    <div id="dot-1" class="breadcrumb-dot w-3 h-3 rounded-full bg-white/10"></div>
                    <div id="dot-2" class="breadcrumb-dot w-3 h-3 rounded-full bg-white/10"></div>
                    <div id="dot-3" class="breadcrumb-dot w-3 h-3 rounded-full bg-white/10"></div>
                    <div id="dot-4" class="breadcrumb-dot w-3 h-3 rounded-full bg-white/10"></div>
                </div>

                <div id="step-1" class="step-content space-y-6">
                    <h2 class="text-2xl font-bold uppercase tracking-tighter">1. Personal Details</h2>
                    <div id="dynamic-inputs" class="space-y-4"></div>
                    <button onclick="nextStep(2)" class="w-full bg-uni-blue py-4 rounded-xl font-bold">Next: Generate Keys</button>
                </div>

                <div id="step-2" class="step-content hidden space-y-6">
                    <h2 class="text-2xl font-bold uppercase tracking-tighter">2. Digital Identity</h2>
                    <div class="p-6 bg-black rounded-2xl border border-white/5 space-y-6">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Public ADA Address (Shareable)</label>
                            <div id="pub-key-display" class="font-mono text-[11px] break-all text-blue-400 mt-1"></div>
                        </div>
                        <div class="pt-4 border-t border-white/10">
                            <label class="text-[10px] text-red-500 uppercase font-bold">Private Key (Hidden - Do Not Share)</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="password" id="priv-key-display" readonly class="flex-1 bg-transparent border-none text-[11px] font-mono">
                                <button onclick="toggleKeyVisibility()" class="text-[10px] underline">SHOW</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="nextStep(3)" class="w-full bg-uni-blue py-4 rounded-xl font-bold">Next: Verification Purpose</button>
                </div>

                <div id="step-3" class="step-content hidden space-y-6">
                    <h2 class="text-2xl font-bold uppercase tracking-tighter">3. Agreement Purpose</h2>
                    <div class="space-y-4">
                        <input type="text" id="issuer" placeholder="Who is doing the verification? (e.g. UR Registrar)" class="w-full p-4 rounded-xl">
                        <input type="text" id="receiver" placeholder="Who needs this verification? (e.g. BK Bank)" class="w-full p-4 rounded-xl">
                        <textarea id="purpose" placeholder="What is the specific purpose? (e.g. Loan Application)" class="w-full p-4 rounded-xl h-24"></textarea>
                    </div>
                    <button onclick="nextStep(4)" class="w-full bg-uni-blue py-4 rounded-xl font-bold">Next: Final Review</button>
                </div>

                <div id="step-4" class="step-content hidden space-y-6">
                    <h2 class="text-2xl font-bold uppercase tracking-tighter">4. Final Review</h2>
                    <div id="review-summary" class="text-sm space-y-3 max-h-60 overflow-y-auto"></div>
                    <button onclick="finalizeOnboarding()" class="w-full bg-green-600 py-4 rounded-xl font-bold uppercase">Sign & Submit</button>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view-section">
            <div class="glass-card p-10 rounded-[2.5rem] border-green-500/30">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center text-green-500">
                        <i data-lucide="check-circle"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Identity Active</h2>
                        <p class="text-gray-500 text-sm">Your information is stored and retrievable via your key.</p>
                    </div>
                </div>
                <div id="dashboard-content" class="space-y-4"></div>
                <button onclick="location.reload()" class="mt-8 text-uni-blue text-xs font-bold uppercase tracking-widest">Logout / Restart</button>
            </div>
        </div>

    </main>

    <script type="module">
        // SIMPLE BECH32 ENCODER FOR ADA STYLE ADDRESSES
        const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
        function encodeBech32(prefix, dataHex) {
            let words = [];
            for (let i = 0; i < dataHex.length; i += 2) words.push(parseInt(dataHex.substr(i, 2), 16) >> 3);
            let combined = prefix + '1';
            for (let i = 0; i < words.length; i++) combined += CHARSET[words[i] % 32];
            return combined;
        }

        let currentRole = "";
        let currentStep = 1;
        let userData = {};

        // INITIALIZE APP
        window.addEventListener('load', () => {
            lucide.createIcons();
            checkExistingUser();
        });

        // 1. START WIZARD
        window.startWizard = (role) => {
            currentRole = role;
            currentStep = 1;
            const container = document.getElementById('dynamic-inputs');
            container.innerHTML = "";
            
            const fields = {
                student: [{l:"Legal Name",id:"name"}, {l:"University",id:"inst"}, {l:"Student ID",id:"sid"}],
                sacco: [{l:"Full Name",id:"name"}, {l:"Member ID",id:"mid"}, {l:"SACCO Name",id:"inst"}],
                p2p: [{l:"Full Name",id:"name"}, {l:"National ID",id:"nid"}, {l:"Target Amount",id:"amt"}]
            };

            fields[role].forEach(f => {
                container.innerHTML += `<div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase ml-2">${f.l}</label>
                    <input type="text" id="inp-${f.id}" data-label="${f.l}" class="w-full p-4 rounded-xl wizard-input">
                </div>`;
            });

            switchView('wizard');
            updateBreadcrumbs();
        };

        // 2. WIZARD NAVIGATION & KEY GEN
        window.nextStep = async (step) => {
            if (step === 2) {
                // Collect Step 1
                let hasEmpty = false;
                document.querySelectorAll('.wizard-input').forEach(i => {
                    if(!i.value) hasEmpty = true;
                    userData[i.dataset.label] = i.value;
                });
                if(hasEmpty) return showModal("Wait", "Please fill all info first.", "error");

                // Generate ADA Address
                const seed = userData[Object.keys(userData)[0]] + Date.now();
                const hash = await generateHash(seed);
                userData.publicKey = encodeBech32("addr", hash.substring(0, 40));
                userData.privateKey = encodeBech32("skey", hash.substring(40, 64));

                document.getElementById('pub-key-display').innerText = userData.publicKey;
                document.getElementById('priv-key-display').value = userData.privateKey;
            }

            if (step === 4) {
                userData.issuer = document.getElementById('issuer').value;
                userData.receiver = document.getElementById('receiver').value;
                userData.purpose = document.getElementById('purpose').value;

                const summary = document.getElementById('review-summary');
                summary.innerHTML = `<p class="text-[10px] text-uni-blue font-bold uppercase">Role: ${currentRole}</p>`;
                Object.entries(userData).forEach(([k, v]) => {
                    if(k === 'privateKey') return;
                    summary.innerHTML += `<div class="border-b border-white/5 pb-2">
                        <p class="text-gray-500 text-[9px] uppercase">${k}</p>
                        <p class="font-bold">${v}</p>
                    </div>`;
                });
            }

            document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            currentStep = step;
            updateBreadcrumbs();
        };

        // 3. FINALIZE & PERSIST (REMEMBERS USER)
        window.finalizeOnboarding = async () => {
            // Save to LocalStorage to "Remember" the user
            localStorage.setItem('unichain_identity', JSON.stringify({
                role: currentRole,
                data: userData
            }));

            showModal("Success", "Identity verified and anchored. Your keys are now active.", "success");
            
            setTimeout(() => {
                switchView('dashboard');
                renderDashboard();
            }, 2000);
        };

        // 4. RETRIEVAL LOGIC
        function checkExistingUser() {
            const saved = localStorage.getItem('unichain_identity');
            if(saved) {
                const parsed = JSON.parse(saved);
                userData = parsed.data;
                currentRole = parsed.role;
                document.getElementById('status-text').innerText = "Identified";
                switchView('dashboard');
                renderDashboard();
            }
        }

        function renderDashboard() {
            const dash = document.getElementById('dashboard-content');
            dash.innerHTML = `
                <div class="p-4 bg-uni-blue/10 border border-uni-blue/20 rounded-2xl mb-4">
                    <p class="text-[9px] text-uni-blue uppercase font-bold">Public Key (Retrieval ID)</p>
                    <p class="font-mono text-[10px] break-all">${userData.publicKey}</p>
                </div>
            `;
            Object.entries(userData).forEach(([k, v]) => {
                if(k === 'privateKey' || k === 'publicKey') return;
                dash.innerHTML += `
                    <div class="flex justify-between border-b border-white/5 pb-2">
                        <span class="text-gray-500 text-xs">${k}</span>
                        <span class="font-bold text-xs">${v}</span>
                    </div>
                `;
            });
        }

        // HELPERS
        async function generateHash(str) {
            const msgBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        window.switchView = (id) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.add('active');
            lucide.createIcons();
        };

        window.updateBreadcrumbs = () => {
            document.querySelectorAll('.breadcrumb-dot').forEach((dot, idx) => {
                dot.classList.toggle('active', idx < currentStep);
            });
        };

        window.toggleKeyVisibility = () => {
            const el = document.getElementById('priv-key-display');
            el.type = el.type === 'password' ? 'text' : 'password';
        };

        window.showModal = (title, msg, type) => {
            const m = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            m.classList.add('active');
        };

        window.closeModal = () => document.getElementById('custom-modal').classList.remove('active');
    </script>
</body>
</html>